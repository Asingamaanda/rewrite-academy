{% extends "base.html" %}
{% block title %}{{ student.name }} â€” My Portal{% endblock %}

{% block content %}
<div style="padding:2rem 0 110px;">

    {% if payment_restricted %}
    <!-- Payment Restriction Banner -->
    <div style="background:rgba(244,114,182,.1);border:1px solid rgba(244,114,182,.35);border-radius:12px;
                padding:16px 22px;margin-bottom:20px;display:flex;align-items:center;gap:14px;">
      <span style="font-size:1.4rem;">ðŸ”’</span>
      <div>
        <div style="font-weight:700;color:#f472b6;font-size:.9rem;">Account Restricted â€” Payment Overdue</div>
        <div style="font-size:.82rem;color:rgba(255,255,255,.5);margin-top:3px;">
          Your account has an outstanding balance. Please make payment to restore full access.
          Contact your teacher to resolve this.
        </div>
      </div>
    </div>
    {% endif %}

    <!-- â”€â”€ Hero banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div style="position:relative;overflow:hidden;background:linear-gradient(135deg,rgba(8,145,178,0.14),rgba(34,211,238,0.04));border:1px solid rgba(34,211,238,0.22);border-radius:24px;padding:2.4rem 2.4rem 2rem;margin-bottom:1.5rem;">
        <div style="position:absolute;top:-80px;right:-80px;width:260px;height:260px;background:radial-gradient(circle,rgba(34,211,238,0.1),transparent 70%);pointer-events:none;"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1.5rem;position:relative;">
            <div style="display:flex;align-items:center;gap:1.5rem;">
                <div style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#0891b2,#22d3ee);display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:#000;flex-shrink:0;box-shadow:0 0 28px rgba(34,211,238,0.35);">{{ student.name[0].upper() }}</div>
                <div>
                    <div style="font-size:0.76rem;color:rgba(255,255,255,0.38);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;">Welcome back</div>
                    <h1 style="font-family:'Playfair Display',serif;font-size:2.1rem;font-weight:700;margin:0;line-height:1.1;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.7));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{{ student.name }}</h1>
                    <div style="font-size:0.82rem;color:rgba(255,255,255,0.38);margin-top:5px;">{{ student.student_id }} &nbsp;Â·&nbsp; {{ today }}</div>
                </div>
            </div>
            <div style="{% if student.risk_level == 'low' %}background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.35);color:#4ade80;{% elif student.risk_level == 'medium' %}background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.35);color:#22d3ee;{% else %}background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.35);color:#f87171;{% endif %}padding:10px 24px;border-radius:100px;font-size:0.9rem;font-weight:700;letter-spacing:.04em;">
                {% if student.risk_level == 'low' %}On Track{% elif student.risk_level == 'medium' %}Needs Focus{% else %}Needs Attention{% endif %}
            </div>
        </div>
    </div>

    <!-- â”€â”€ Stats row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="grid grid-cols-4" style="gap:1rem;margin-bottom:1.5rem;">
        {% set avg = student.overall_average %}
        {% set att = student.attendance_rate %}
        {% set avg_color = '#4ade80' if avg >= 70 else ('#22d3ee' if avg >= 50 else '#f87171') %}
        {% set att_color = '#4ade80' if att >= 80 else ('#22d3ee' if att >= 60 else '#f87171') %}

        <div class="card-cinematic" style="text-align:center;padding:1.5rem 0.5rem;">
            <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,0.38);margin-bottom:8px;">Average</div>
            <div style="font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:700;color:{{ avg_color }};line-height:1;">{{ avg }}%</div>
            <div class="progress-bar-bg" style="margin-top:10px;"><div class="progress-bar-fill" style="width:{{ avg }}%;background:{{ avg_color }};"></div></div>
        </div>

        <div class="card-cinematic" style="text-align:center;padding:1.5rem 0.5rem;">
            <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,0.38);margin-bottom:8px;">Attendance</div>
            <div style="font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:700;color:{{ att_color }};line-height:1;">{{ att }}%</div>
            <div class="progress-bar-bg" style="margin-top:10px;"><div class="progress-bar-fill" style="width:{{ att }};background:{{ att_color }};"></div></div>
        </div>

        <div class="card-cinematic" style="text-align:center;padding:1.5rem 0.5rem;">
            <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,0.38);margin-bottom:8px;">Subjects</div>
            <div style="font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:700;color:#fff;line-height:1;">{{ student.subjects|length }}</div>
            <div style="font-size:0.72rem;color:rgba(255,255,255,0.28);margin-top:8px;">enrolled</div>
        </div>

        {% set total_vids = video_counts.values()|sum if video_counts else 0 %}
        <div class="card-cinematic" style="text-align:center;padding:1.5rem 0.5rem;">
            <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,0.38);margin-bottom:8px;">Videos</div>
            <div style="font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:700;color:#22d3ee;line-height:1;">{{ total_vids }}</div>
            <div style="font-size:0.72rem;color:rgba(255,255,255,0.28);margin-top:8px;">available</div>
        </div>
    </div>

    <!-- â”€â”€ Today + Subjects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="grid grid-cols-2" style="gap:1.5rem;margin-bottom:1.5rem;">

        <!-- Today's classes -->
        <div class="glass-container" style="padding:1.6rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;">
                <h3 style="font-family:'Playfair Display',serif;font-size:1rem;color:#22d3ee;margin:0;">Today's Classes</h3>
                <a href="/my-portal/timetable" style="font-size:0.75rem;color:rgba(255,255,255,0.28);text-decoration:none;transition:color .2s;" onmouseover="this.style.color='#22d3ee'" onmouseout="this.style.color='rgba(255,255,255,0.28)'">Full schedule â†’</a>
            </div>
            {% if schedule %}
            <div style="display:flex;flex-direction:column;gap:8px;">
                {% for slot in schedule %}
                <div style="background:rgba(34,211,238,0.04);border:1px solid rgba(34,211,238,0.14);border-left:3px solid #22d3ee;border-radius:0 10px 10px 0;padding:11px 14px;display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-weight:600;font-size:0.9rem;">{{ slot.subject if slot.subject is defined else slot }}</div>
                        {% if slot.time_from is defined and slot.time_from %}
                        <div style="font-size:0.76rem;color:rgba(255,255,255,0.38);margin-top:2px;">{{ slot.time_from }} â€“ {{ slot.time_to }}{% if slot.teacher is defined and slot.teacher %} &nbsp;Â·&nbsp; {{ slot.teacher }}{% endif %}</div>
                        {% endif %}
                    </div>
                    {% if slot.room is defined and slot.room %}
                    <span style="font-size:0.72rem;color:rgba(255,255,255,0.28);background:rgba(255,255,255,0.05);padding:3px 10px;border-radius:8px;">Rm. {{ slot.room }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.2);font-size:0.85rem;">No classes today</div>
            {% endif %}
        </div>

        <!-- Subjects with performance trends -->
        <div class="glass-container" style="padding:1.6rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;">
                <h3 style="font-family:'Playfair Display',serif;font-size:1rem;color:#22d3ee;margin:0;">My Subjects</h3>
                <a href="/my-portal/progress" style="font-size:0.75rem;color:rgba(255,255,255,0.28);text-decoration:none;" onmouseover="this.style.color='#22d3ee'" onmouseout="this.style.color='rgba(255,255,255,0.28)'">Full report â†’</a>
            </div>
            <div style="display:flex;flex-direction:column;gap:12px;">
                {% for subject in student.subjects %}
                {% set perf = performance.get(subject) if performance else none %}
                {% set sc = '#4ade80' if (perf and perf.average >= 70) else ('#22d3ee' if (perf and perf.average >= 50) else '#f87171') %}
                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                        <span style="font-size:0.88rem;font-weight:500;">{{ subject }}</span>
                        <div style="display:flex;align-items:center;gap:6px;">
                            {% if perf %}
                            <span style="font-size:0.8rem;font-weight:700;color:{{ sc }};">{{ perf.average|round(1) }}%</span>
                            {% if perf.trend == 'improving' %}<span style="color:#4ade80;font-size:0.85rem;font-weight:700;" title="Improving">&#8679;</span>
                            {% elif perf.trend == 'declining' %}<span style="color:#f87171;font-size:0.85rem;font-weight:700;" title="Declining">&#8681;</span>
                            {% else %}<span style="color:rgba(255,255,255,0.2);font-size:0.8rem;" title="Stable">&#8594;</span>{% endif %}
                            {% else %}<span style="font-size:0.72rem;color:rgba(255,255,255,0.2);">No data</span>{% endif %}
                            {% if video_counts and video_counts.get(subject, 0) > 0 %}
                            <span style="font-size:0.68rem;color:#22d3ee;background:rgba(34,211,238,0.08);border:1px solid rgba(34,211,238,0.2);padding:1px 7px;border-radius:20px;">{{ video_counts[subject] }}v</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="progress-bar-bg" style="height:5px;"><div class="progress-bar-fill" style="width:{% if perf %}{{ perf.average }}{% else %}0{% endif %}%;background:{% if perf %}{{ sc }}{% else %}rgba(255,255,255,0.08){% endif %};height:5px;box-shadow:none;"></div></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- â”€â”€ Recent results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {% if assessments %}
    <div class="glass-container" style="padding:1.6rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;">
            <h3 style="font-family:'Playfair Display',serif;font-size:1rem;color:#22d3ee;margin:0;">Recent Results</h3>
            <a href="/my-portal/progress" style="font-size:0.75rem;color:rgba(255,255,255,0.28);text-decoration:none;" onmouseover="this.style.color='#22d3ee'" onmouseout="this.style.color='rgba(255,255,255,0.28)'">All results â†’</a>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:0.9rem;">
            {% for a in assessments %}
            {% set pc = '#4ade80' if a.percentage >= 70 else ('#22d3ee' if a.percentage >= 50 else '#f87171') %}
            <div style="background:rgba(255,255,255,0.028);border:1px solid rgba(255,255,255,0.07);border-top:2px solid {{ pc }};border-radius:10px;padding:13px 15px;">
                <div style="font-size:0.84rem;font-weight:600;margin-bottom:2px;">{{ a.subject }}</div>
                <div style="font-size:0.74rem;color:rgba(255,255,255,0.32);margin-bottom:10px;">{{ a.type }} Â· {{ a.date }}</div>
                <div style="display:flex;justify-content:space-between;align-items:baseline;">
                    <span style="font-size:0.78rem;color:rgba(255,255,255,0.35);">{{ a.score }}/{{ a.max_score }}</span>
                    <span style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:{{ pc }};">{{ a.percentage }}%</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<!-- Fixed Bottom Nav -->
<div style="position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);z-index:9999;">
    <div style="background:rgba(10,10,10,0.97);backdrop-filter:blur(24px);border:1px solid rgba(255,255,255,0.1);border-radius:100px;padding:6px;display:flex;gap:4px;box-shadow:0 8px 40px rgba(0,0,0,0.6);">
        <a href="/my-portal" style="display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 22px;border-radius:100px;text-decoration:none;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;"><span style="font-size:1rem;">âŠ¡</span>Home</a>
        <a href="/my-portal/subjects" style="display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 22px;border-radius:100px;text-decoration:none;color:rgba(255,255,255,0.35);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.9)'" onmouseout="this.style.color='rgba(255,255,255,0.35)'"><span style="font-size:1rem;">ðŸ“š</span>Subjects</a>
        <a href="/my-portal/timetable" style="display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 22px;border-radius:100px;text-decoration:none;color:rgba(255,255,255,0.35);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.9)'" onmouseout="this.style.color='rgba(255,255,255,0.35)'"><span style="font-size:1rem;">â—«</span>Schedule</a>
        <a href="/my-portal/progress" style="display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 22px;border-radius:100px;text-decoration:none;color:rgba(255,255,255,0.35);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.9)'" onmouseout="this.style.color='rgba(255,255,255,0.35)'"><span style="font-size:1rem;">â—ˆ</span>Progress</a>
    </div>
</div>
{% endblock %}
