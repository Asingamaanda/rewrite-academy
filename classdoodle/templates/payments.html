{% extends "base.html" %}
{% block title %}Payments ‚Äî Rewrite Academy{% endblock %}

{% block extra_css %}
<style>
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.75rem;}
@media(max-width:900px){.stat-row{grid-template-columns:repeat(2,1fr);}}
.stat-tile{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:1.25rem 1.5rem;text-align:center;}
.stat-tile .val{font-size:1.75rem;font-weight:700;font-family:'Playfair Display',serif;}
.stat-tile .lbl{font-size:0.75rem;color:var(--text-muted);margin-top:4px;text-transform:uppercase;letter-spacing:0.06em;}
.table-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden;margin-bottom:1.75rem;}
.table-card-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.table-card-header h3{font-size:0.85rem;font-weight:700;color:var(--text);font-family:'Inter',sans-serif;}
.filter-bar{display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:1rem 1.25rem;margin-bottom:1.75rem;}
/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:2000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);padding:2rem;width:100%;max-width:480px;box-shadow:0 24px 80px rgba(0,0,0,0.7);}
.modal-title{font-size:1rem;font-weight:700;color:var(--accent);margin-bottom:1.5rem;padding-bottom:0.75rem;border-bottom:1px solid var(--border);font-family:'Inter',sans-serif;text-transform:uppercase;letter-spacing:0.07em;}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="flex-between">
        <div>
            <h1>üí≥ Payment Management</h1>
            <p>Track monthly fees and outstanding balances</p>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="stat-row">
    <div class="stat-tile">
        <div class="val" style="color:#34d399;">R{{ payment_status.total_revenue|default(0,true)|round(2)|format_number }}</div>
        <div class="lbl">Revenue This Month</div>
    </div>
    <div class="stat-tile">
        <div class="val" style="color:var(--accent);">{{ payment_status.paid_count }}</div>
        <div class="lbl">Paid</div>
    </div>
    <div class="stat-tile">
        <div class="val" style="color:#fca5a5;">{{ payment_status.outstanding_count }}</div>
        <div class="lbl">Outstanding</div>
    </div>
    <div class="stat-tile">
        <div class="val" style="color:#fbbf24;">R{{ (payment_status.outstanding_count * 1500)|format_number }}</div>
        <div class="lbl">Expected Owed</div>
    </div>
</div>

<!-- Month selector -->
<form method="GET" action="/payments">
    <div class="filter-bar">
        <label style="margin-bottom:0;white-space:nowrap;">Month</label>
        <input type="month" name="month" value="{{ selected_month }}" style="width:auto;">
        <button type="submit" class="btn-cinematic">View</button>
    </div>
</form>

<!-- Outstanding -->
{% if payment_status.outstanding %}
<div class="table-card">
    <div class="table-card-header">
        <h3>‚ö†Ô∏è Outstanding ({{ payment_status.outstanding_count }})</h3>
        <span class="badge badge-red">Action Required</span>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Student ID</th><th>Name</th><th>Parent</th><th>Amount Due</th><th></th>
            </tr>
        </thead>
        <tbody>
            {% for student in payment_status.outstanding %}
            <tr>
                <td><span style="color:var(--accent);font-weight:700;">{{ student.student_id }}</span></td>
                <td>{{ student.name }}</td>
                <td>
                    {{ student.parent_name }}<br>
                    <span style="font-size:0.78rem;color:var(--text-faint);">{{ student.parent_phone }}</span>
                </td>
                <td><span class="badge badge-red">R1,500.00</span></td>
                <td>
                    <button onclick="openPayment('{{ student.student_id }}','{{ student.name }}')" class="btn-gold" style="padding:6px 14px;font-size:0.82rem;">
                        üí≥ Record Payment
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Paid -->
{% if payment_status.paid %}
<div class="table-card">
    <div class="table-card-header">
        <h3>‚úÖ Paid Students ({{ payment_status.paid_count }})</h3>
        <span class="badge badge-green">Cleared</span>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Student ID</th><th>Name</th><th>Amount</th><th>Date</th><th>Method</th><th>Reference</th>
            </tr>
        </thead>
        <tbody>
            {% for item in payment_status.paid %}
            <tr>
                <td><span style="color:var(--accent);font-weight:700;">{{ item.student.student_id }}</span></td>
                <td>{{ item.student.name }}</td>
                <td><span class="badge badge-green">R{{ item.payment.amount|round(2) }}</span></td>
                <td>{{ item.payment.payment_date }}</td>
                <td>{{ item.payment.payment_method }}</td>
                <td style="font-size:0.8rem;color:var(--text-faint);">{{ item.payment.reference or '‚Äî' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- All-time summary -->
{% if revenue_summary and revenue_summary.get('total_revenue') %}
<div class="stat-row" style="margin-top:0;">
    <div class="stat-tile">
        <div class="val" style="color:#34d399;">R{{ revenue_summary.total_revenue|round(2)|format_number }}</div>
        <div class="lbl">Total Revenue (All Time)</div>
    </div>
    <div class="stat-tile">
        <div class="val" style="color:var(--accent);">{{ revenue_summary.payment_count }}</div>
        <div class="lbl">Total Payments</div>
    </div>
    <div class="stat-tile">
        <div class="val" style="color:#fbbf24;">R{{ revenue_summary.avg_payment|round(2)|format_number }}</div>
        <div class="lbl">Average Payment</div>
    </div>
    <div class="stat-tile">
        <div class="val" style="color:var(--text-muted);">‚Äî</div>
        <div class="lbl">&nbsp;</div>
    </div>
</div>
{% endif %}

<!-- Record payment modal -->
<div id="paymentModal" class="modal-overlay" onclick="if(event.target===this)closePayment()">
    <div class="modal-box">
        <div class="modal-title">üí≥ Record Payment</div>
        <form id="paymentForm" method="POST" action="/payment/record">
            <input type="hidden" name="student_id" id="pay_sid">
            <input type="hidden" name="month_for" value="{{ selected_month }}">

            <div class="form-group">
                <label>Student</label>
                <input type="text" id="pay_name" readonly style="opacity:0.7;">
            </div>
            <div class="form-group">
                <label>Amount (R) *</label>
                <input type="number" name="amount" value="1500" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Payment Method</label>
                <select name="payment_method">
                    <option>Cash</option>
                    <option>EFT</option>
                    <option>Card</option>
                    <option>Mobile Money</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reference (optional)</label>
                <input type="text" name="reference" placeholder="Transaction ID or reference number">
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1.25rem;">
                <button type="submit" class="btn-gold" style="flex:1;justify-content:center;padding:0.8rem;">‚úÖ Confirm</button>
                <button type="button" onclick="closePayment()" class="btn-outline" style="flex:1;justify-content:center;padding:0.8rem;">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function openPayment(sid, name) {
    document.getElementById('pay_sid').value = sid;
    document.getElementById('pay_name').value = name;
    document.getElementById('paymentModal').classList.add('open');
}
function closePayment() {
    document.getElementById('paymentModal').classList.remove('open');
}
</script>
{% endblock %}
